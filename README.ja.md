# Mewduct

![Mewduct Logo](doc/img/mewduct-logo.png)

Video streaming CMS without a server-side application

## Description

Mewductは動画配信サイトの構成をクライアントサイドアプリケーションと、webサーバーが静的配信するファイルで実現しています。
サーバー上に配信するファイルを配置するだけで良いので、サーバー側にアプリケーションサーバーを必要とせず、動画処理をローカルで行えるためサーバーインスタンスに対するリソース要求を非常に小さく抑えることができます。

配信に必要なファイルの構成は、コマンドラインスクリプトによって行います。
一部の設定(動画のタイトルや説明文の設定など)はコマンドラインスクリプトによって提供されておらず、ファイルを直接編集することが実現します。

コマンドラインスクリプトの役割は、動画配信で使われるファイルを正しく配置することです。
動画を変換した出力先をサーバーのファイルシステム上にしてサーバーに取り込むこともできますし、ローカルファイルシステム上に完全なファイルツリーを構成し、`rsync`でサーバーに同期することもできます。
このあたりは完全に自由です。

Mewductはマルチユーザーに対応していますが、動画アップロード時にコマンドを実行する必要があるため、マルチユーザーで動画をアップロードするのに適した機能が提供されていません。
ただ、アップロードされたときにフックしてコマンドを実行すれば良いだけなので、作るのは難しくないでしょう。

Mewductは視聴者にユーザーアカウントを要求しません。
このため、公開する相手を限定した動画は設定できません。
ただし、ホームやユーザーページに掲載しないという意味の限定公開動画は設定可能です。

## ビデオのインポートと更新

### 新しいビデオを生成する

まずアップロードしたい動画を用意し、これを様々な解像度の動画ファイルを含むMewduct用のビデオに変換します。

MewductにインポートするときはMewductのCLIツールが変換されたファイルと公開ディレクトリに両方にアクセスする必要がありますが、この変換の出力先はローカルとサーバーどちらでも構いません。
ローカルで生成した場合は公開ディレクトリをローカルにマウントしてインポートすることもできますし、生成したディレクトリをサーバーにアップロードしてサーバーでインポートすることもできます。

```
mewduct-encode.zsh <source_video> [<output_directory>]
```

出力先ディレクトリを省略した場合、`./videoout`に出力されます。

`mewduct-encode.zsh`は候補となる解像度の中から変換可能なもののみを`ffmpeg`で変換します。
通常はMPEG4 baselineで、HD以上の動画はVP9になります。

また、サムネイル画像として使用される`thumbnail.webp`と、作品に関するメタデータを手書きするための`titlemeta.yaml`も生成されます。
インポートする前に`titlemeta.yaml`を更新し、カスタムサムネイルを使いたい場合は`thumbnail.webp`を差し替えることをおすすめします。

### ビデオをインポートする

```
mewduct-import.zsh <webroot> <user_id> <video_directory>
```

Mewductにおける「ビデオのインポート」とは、「`media_id`を生成し、Mewduct向けのソース動画ディレクトリを`user/$user/$media_id`に`mv`する」ということを意味します。

`mewduct-import.zsh`は自動的に`mewduct-update.rb`を呼び出します。

インポートが完了したあと、`mewduct-import.zsh`は`$user/$media_id`のパスを出力します。
これは通常はメモしておく必要ありませんが、動画のメタデータを更新したい場合などには必要になります。

ただ、適切にタイトルをつけているのであれば、後から`/media/$user/*/titlemeta.yaml`を探索して見つけることもできるでしょう。

### ビデオを更新する

```
mewduct-update.rb <webroot_dir> <user_id> <media_id>
```

Mewductにおけるビデオの更新は、動画ディレクトリのメタデータを更新したり、新しい解像度の動画を追加したことを反映することを意味します。
その更新が初回であるならば、必要なメタデータJSONを生成するという意味もあります。

既存の動画ファイルを更新したり、字幕ファイルを置き換えた場合は更新しなくても自動的に反映されます。

字幕ファイルは`captions.<langcode>.vtt`というファイルがあれば、これを字幕として取り込みます。