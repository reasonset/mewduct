# ビデオのインポートと更新

## 新しいビデオを生成する

まずアップロードしたい動画を用意し、これを様々な解像度の動画ファイルを含むMewduct用のビデオに変換します。

MewductにインポートするときはMewductのCLIツールが変換されたファイルと公開ディレクトリに両方にアクセスする必要がありますが、この変換の出力先はローカルとサーバーどちらでも構いません。
ローカルで生成した場合は公開ディレクトリをローカルにマウントしてインポートすることもできますし、生成したディレクトリをサーバーにアップロードしてサーバーでインポートすることもできます。

```
mewduct-encode.zsh <source_video> [<output_directory>]
```

出力先ディレクトリを省略した場合、`./videoout`に出力されます。

`mewduct-encode.zsh`は候補となる解像度の中から変換可能なもののみを`ffmpeg`で変換します。
通常はMPEG4 baselineで、HD以上の動画はVP9になります。

また、サムネイル画像として使用される`thumbnail.webp`と、作品に関するメタデータを手書きするための`titlemeta.yaml`も生成されます。
インポートする前に`titlemeta.yaml`を更新し、カスタムサムネイルを使いたい場合は`thumbnail.webp`を差し替えることをおすすめします。

## ビデオをインポートする

```
mewduct-import.zsh <webroot> <user_id> <video_directory>
```

Mewductにおける「ビデオのインポート」とは、「`media_id`を生成し、Mewduct向けのソース動画ディレクトリを`user/$user/$media_id`に`mv`する」ということを意味します。

`mewduct-import.zsh`は自動的に`mewduct-update.rb`を呼び出します。

インポートが完了したあと、`mewduct-import.zsh`は`$user/$media_id`のパスを出力します。
これは通常はメモしておく必要ありませんが、動画のメタデータを更新したい場合などには必要になります。

ただ、適切にタイトルをつけているのであれば、後から`/media/$user/*/titlemeta.yaml`を探索して見つけることもできるでしょう。

## ビデオを更新する

```
mewduct-update.rb <webroot_dir> <user_id> <media_id>
```

Mewductにおけるビデオの更新は、動画ディレクトリのメタデータを更新したり、新しい解像度の動画を追加したことを反映することを意味します。
その更新が初回であるならば、必要なメタデータJSONを生成するという意味もあります。

既存の動画ファイルを更新したり、字幕ファイルを置き換えた場合は更新しなくても自動的に反映されます。

字幕ファイルは`captions.<langcode>.vtt`というファイルがあれば、これを字幕として取り込みます。